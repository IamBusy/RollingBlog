title: 关于ETCD同步的设计错误
date: 2016-06-23 07:04:36
categories: 技术
tags: [etcd]
---

## 背景

做配置同步，机器数量非常非常多。错误波及范围在几百台，一方面我是数据流设计的太过负载没有做好功能上的取舍，造成了服务发现端与agent端双写的状态。以及由于错误的操作计划导致，不正确的异常处理造成的综合错误。

## 服务异常处理设计错误

1. 在服务配置解析的异常处理中直接使用了暴力的进程Fatal进行处理，导致进程在初始化结束之后还在做类似的处理。*每隔一段事件应该检查一下类似的问题。不然会造成明显的系统崩溃*
2. 历史原因： 在之前的开发中由于配置的初始化处于初始化的位置，后来因为设计修改。变成了配置重新载入时候的代码引入了此bug。
3. 在抛出错误之后，并没有对系统状态，或者当前的业务逻辑进行错误处理，只处理了错误数据。比如说该逻辑应该`break` 或者 `continue` 或者 `return` 这部分容易落下。

当前最高时间性价比错误避免的方法：

1. 基于上面的错误发生应该反复核对设计图纸，对于服务器比较多的场景，更应该对设计图纸的重视程度反复核对有没有设计上的逻辑错误。
2. 使用测试的方法来防止细节上的错误。
3. 在开发中逻辑最清晰的时候在工作日志中标记出测试Case

模块逻辑设计的清晰度问题

暴力使用ETCD的事

双写的问题。这里面是要有妥协与平衡的。

技术全局性的不足，主要是我只想到了一个项目的工作流没有想到其他相关项目的工作流，解耦问题，以及数据读写流的问题。

自动化的重要性

自动化测试的几个要素

